
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Constrained Template Matching &#8212; pytme 0.3.b0 documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  <!--
    this give us a css class that will be invisible only if js is disabled
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=8f2a1f02" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/plot_directive.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/general.css?v=2e4b593a" />
  
  <!-- So that users can add custom icons -->
  <script src="../../_static/scripts/fontawesome.js?digest=8878045cc6db502f8baf"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf" />

    <script src="../../_static/documentation_options.js?v=97acad5b"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=4ea706d9"></script>
    <script src="../../_static/design-tabs.js?v=f930bc37"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'quickstart/matching/constrained';</script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Fitting Atomic Structures" href="fitting.html" />
    <link rel="prev" title="Picking Ribosomes" href="particle_picking.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="" />
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="pst-navbar-icon sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">

  
    
  

<a class="navbar-brand logo" href="../../index.html">
  
  
  
  
  
  
    <p class="title logo__title">pytme</p>
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item current active">
  <a class="nav-link nav-internal" href="../index.html">
    User Guide
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../reference/index.html">
    API
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../genindex.html">
    Index
  </a>
</li>

  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
        </div>
      
      
        <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
      
        <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/KosinskiLab/pyTME" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
</ul></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
    </div>
  

  
    <button class="pst-navbar-icon sidebar-toggle secondary-toggle" aria-label="On this page">
      <span class="fa-solid fa-outdent"></span>
    </button>
  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item current active">
  <a class="nav-link nav-internal" href="../index.html">
    User Guide
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../reference/index.html">
    API
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../genindex.html">
    Index
  </a>
</li>

  </ul>
</nav></div>
          
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
        
          <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/KosinskiLab/pyTME" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
</ul></div>
        
      </div>
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
<nav class="bd-docs-nav bd-links"
     aria-label="Section Navigation">
  <p class="bd-links__title" role="heading" aria-level="1">Section Navigation</p>
  <div class="bd-toc-item navbar-nav"><p aria-level="2" class="caption" role="heading"><span class="caption-text">Get Started</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation</a></li>




</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Template Matching</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="motivation.html">Motivation</a></li>
<li class="toctree-l1 current active has-children"><a class="reference internal" href="example.html">Practical Example</a><details open="open"><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="particle_picking.html">Picking Ribosomes</a></li>
<li class="toctree-l2 current active"><a class="current reference internal" href="#">Constrained Template Matching</a></li>
<li class="toctree-l2"><a class="reference internal" href="fitting.html">Fitting Atomic Structures</a></li>
<li class="toctree-l2"><a class="reference internal" href="alignment.html">Alignment of Densities</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="cluster.html">Cluster Execution</a></li>
<li class="toctree-l1"><a class="reference internal" href="summary.html">Summary</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Postprocessing</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../postprocessing/motivation.html">Motivation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../postprocessing/example.html">Practical Example</a></li>
<li class="toctree-l1"><a class="reference internal" href="../postprocessing/summary.html">Summary</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Further Reading</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../preprocessing/masks.html">Masking</a></li>
<li class="toctree-l1"><a class="reference internal" href="../preprocessing/filters.html">Filtering Techniques</a></li>
<li class="toctree-l1"><a class="reference internal" href="../preprocessing/gui.html">Using the GUI</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Miscellaneous</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../contribution.html">Contribute</a></li>
<li class="toctree-l1"><a class="reference internal" href="../issues.html">Issues</a></li>
<li class="toctree-l1"><a class="reference internal" href="../license.html">License</a></li>
</ul>
</div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
      <div class="sidebar-primary-item">
<div id="ethical-ad-placement"
      class="flat"
      data-ea-publisher="readthedocs"
      data-ea-type="readthedocs-sidebar"
      data-ea-manual="true">
</div></div>
  </div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">

<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="../index.html" class="nav-link">User Guide</a></li>
    
    
    <li class="breadcrumb-item"><a href="example.html" class="nav-link">Practical Example</a></li>
    
    <li class="breadcrumb-item active" aria-current="page"><span class="ellipsis">Constrained Template Matching</span></li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="constrained-template-matching">
<h1>Constrained Template Matching<a class="headerlink" href="#constrained-template-matching" title="Link to this heading">#</a></h1>
<p>Constrained template matching builds upon standard template matching by integrating prior knowledge about where and how particles are oriented in the data. This is particularly valuable for membrane-associated proteins, with known relative orientation to the membrane surface. Such constraints are imposed by seed points, which can be generated from surface parametrizations, but could also originate from unrefined initial picks, e.g., picks from deep-learning without corresponding angular assignment.</p>
<p>Here, we use a specific formulation of constrained template matching that remains computationally efficient and accurate in large or highly curved biological systems <a class="footnote-reference brackets" href="#id5" id="id1" role="doc-noteref"><span class="fn-bracket">[</span>1<span class="fn-bracket">]</span></a>. In the following, we demonstrate the typical workflow for a synthetic Influenza A virus (IAV), where we identify the two glycoproteins hemagglutinin (HA) and neuraminidase (NA) using template matching.</p>
<figure class="align-default" id="id9">
<a class="reference internal image-reference" href="../../_images/data_overview.png"><img alt="../../_images/data_overview.png" src="../../_images/data_overview.png" style="width: 100%;" />
</a>
<figcaption>
<p><span class="caption-text">Simulating IAV tomograms using Mepsi <a class="footnote-reference brackets" href="#id6" id="id2" role="doc-noteref"><span class="fn-bracket">[</span>2<span class="fn-bracket">]</span></a>.</span><a class="headerlink" href="#id9" title="Link to this image">#</a></p>
</figcaption>
</figure>
<section id="prerequisites">
<h2>Prerequisites<a class="headerlink" href="#prerequisites" title="Link to this heading">#</a></h2>
<p>Before starting with constrained template matching, ensure you have access to</p>
<ul class="simple">
<li><p>GPU with CUDA support</p></li>
<li><p>16 GB of RAM</p></li>
</ul>
<p>You can optionally install <a class="reference external" href="https://github.com/maurerv/mosaic">Mosaic</a> to generate seed points.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Constrained template matching is currently only available in the beta-release. You can acquire it by installing from GitHub</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>pip<span class="w"> </span>install<span class="w"> </span>git+https://github.com/KosinskiLab/pyTME.git
</pre></div>
</div>
<p>or from PyPi via</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>pip<span class="w"> </span>install<span class="w"> </span><span class="s2">&quot;pytme==0.3.0b&quot;</span>
</pre></div>
</div>
</div>
</section>
<section id="data-structure">
<h2>Data Structure<a class="headerlink" href="#data-structure" title="Link to this heading">#</a></h2>
<p>All data used throughout the example is available from <a class="reference external" href="https://oc.embl.de/index.php/s/KhbLe0Y1JI61ct8">ownCloud</a>. The data is organized as follows</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>iav_example/
├── tomogram_solvated_ctf_noise.mrc # Simulated IAV tomogram
├── tilt_angles.txt                 # Tilt angles for missing wedge correction
├── templates/
│   ├── ha.pdb                      # HA structure
│   ├── na.pdb                      # NA structure
│   ├── ha_6.8_aligned.mrc          # Preprocessed HA template
│   ├── na_6.8_aligned.mrc          # Preprocessed NA template
│   └── template_mask_6.8.mrc       # Template mask
├── seed_points/
│   └── SeedingPoints_40_80.star    # Pre-generated seed points
└── results/
    ├── ha_matching.pickle          # HA matching results
    └── na_matching.pickle          # NA matching results
</pre></div>
</div>
<p>You can mirror this structure locally to follow along with the example.</p>
</section>
<section id="generating-seed-points">
<h2>Generating Seed Points<a class="headerlink" href="#generating-seed-points" title="Link to this heading">#</a></h2>
<p>When working with membrane proteins, we like to generate seed points using membrane mesh representations from Mosaic <a class="footnote-reference brackets" href="#id7" id="id3" role="doc-noteref"><span class="fn-bracket">[</span>3<span class="fn-bracket">]</span></a>. Mosaic is a graphical user interface that unifies deep-learning-based membrane segmentation, interactive refinement and mesh generation and is available from <a class="reference external" href="https://github.com/maurerv/mosaic">GitHub</a>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>You can use your own methods for generating seed points. Constrained template matching merely expects a STAR file as specification of the constraints with columns for coordinates (rlnCoordinateX, rlnCoordinateY, rlnCoordinateZ) and zyz angles (rlnAngleRot, rlnAngleTilt, rlnAnglePsi).</p>
</div>
<p>Briefly, Mosaic uses membrain-seg <a class="footnote-reference brackets" href="#id8" id="id4" role="doc-noteref"><span class="fn-bracket">[</span>4<span class="fn-bracket">]</span></a> to create an initial segmentation of the viral membrane. This process can be triggered using the <strong>Membrane</strong> button in the <strong>Intelligence</strong> tab. Since the membrane is well resolved, the segmentation can directly be used for mesh creation.</p>
<figure class="align-default" id="id10">
<a class="reference internal image-reference" href="../../_images/iav_segmentation.png"><img alt="../../_images/iav_segmentation.png" src="../../_images/iav_segmentation.png" style="width: 100%;" />
</a>
<figcaption>
<p><span class="caption-text">IAV membrane segmentation in Mosaic. Shown is a yz-projection of the simulated tomogram and the membrane segmentation in red.</span><a class="headerlink" href="#id10" title="Link to this image">#</a></p>
</figcaption>
</figure>
<p>The spherical geometry of the virus can be described by a convex hull, which can be fitted by selecting the membrane segmentation and clicking the <strong>Mesh</strong> button in the <strong>Parametrization</strong> tab. We can now draw seed points from the created mesh. The seed points should roughly align with the center of mass of the glycoproteins, because this is where the templates are expected to match. This alignment does not have to be very precise, but it helps to further constraint matching down the line. You can draw seed points by clicking the drop-down arrow of the <strong>Sample</strong> button, changing the <em>Mode</em> to <em>Distance</em>, the sampling to <em>40</em> and the offset to <em>80</em>.</p>
<ul class="simple">
<li><p>Sampling (40 Å): This controls the distance between adjacent seed points on the surface. Smaller values create denser sampling with more seed points.</p></li>
<li><p>Offset (80 Å): This moves seed points away from the membrane surface along the normal vector. For this IAV example, 80 Å positions the seed points approximately at the center of mass of the glycoproteins.</p></li>
</ul>
<figure class="align-default" id="id11">
<a class="reference internal image-reference" href="../../_images/iav_seedpoints.png"><img alt="../../_images/iav_seedpoints.png" src="../../_images/iav_seedpoints.png" style="width: 100%;" />
</a>
<figcaption>
<p><span class="caption-text">Membrane mesh in blue and drawn seed points in red.</span><a class="headerlink" href="#id11" title="Link to this image">#</a></p>
</figcaption>
</figure>
<p>The distance distribution between seed points and relative to the mesh can be assessed using the <strong>Properties</strong> button in the <strong>Segmentation</strong> tab. To export the created points, right-click the corresponding cluster object and export it as STAR file.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>If you like to learn more about Mosaic, feel free to check out <a class="reference external" href="https://kosinskilab.github.io/mosaic/tutorial/workflows/iav.html">this example</a>.</p>
</div>
</section>
<section id="creating-templates">
<h2>Creating Templates<a class="headerlink" href="#creating-templates" title="Link to this heading">#</a></h2>
<p>To integrate orientational constraints, we need to ensure the template used for matching is in a consistent orientation. Here, we align the principal axis of the template to the z-axis of the coordinate system</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>preprocess.py<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-m<span class="w"> </span>templates/ha.pdb<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-o<span class="w"> </span>templates/ha_6.8_aligned.mrc<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--sampling-rate<span class="w"> </span><span class="m">6</span>.8<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--lowpass<span class="w"> </span><span class="m">15</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--box-size<span class="w"> </span><span class="m">60</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--align-axis<span class="w"> </span><span class="m">2</span>

preprocess.py<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-m<span class="w"> </span>templates/na.pdb<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-o<span class="w"> </span>templates/na_6.8_aligned.mrc<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--sampling-rate<span class="w"> </span><span class="m">6</span>.8<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--lowpass<span class="w"> </span><span class="m">15</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--box-size<span class="w"> </span><span class="m">60</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--align-axis<span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--flip-axis
</pre></div>
</div>
<p>For NA we need to provide the <code class="docutils literal notranslate"><span class="pre">--flip-axis</span></code> flag due to the handedness of the alignment problem. When aligning a protein structure to a principal axis, the algorithm determines the orientation based on the distribution of mass around the center. However, this can result in two possible orientations that are 180° apart - the protein could point “up” or “down” along the chosen axis.</p>
<p>After alignment, your templates should look similar to what is shown here, with the transmembrane region pointing in the direction of negative z and the extracellular domain pointing in direction of z</p>
<figure class="align-right" id="id12">
<a class="reference internal image-reference" href="../../_images/templates.png"><img alt="../../_images/templates.png" src="../../_images/templates.png" style="width: 50%;" />
</a>
<figcaption>
<p><span class="caption-text">HA (left) and NA (right) template densities.</span><a class="headerlink" href="#id12" title="Link to this image">#</a></p>
</figcaption>
</figure>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>For proteins where the alignment axis is not the axis with maximal variation, e.g., membrane proteins including sections of the membrane, the <code class="docutils literal notranslate"><span class="pre">--align_eigenvector</span></code> needs to be adapted (typically to 2 in such cases). For 3D data this value can either be 0, 1, or 2, with the default value being 0.</p>
</div>
</section>
<section id="creating-template-masks">
<h2>Creating Template Masks<a class="headerlink" href="#creating-template-masks" title="Link to this heading">#</a></h2>
<p>Given the overall shape similarity between HA and NA, we can use a cylindrical mask for both. The mask can be created using the <code class="docutils literal notranslate"><span class="pre">preprocessor_gui.py</span></code> utility, by selecting Mask &gt; Tube with height 37, outer radius 10, inner radius 0, center z 23.50, center y 29, center x 29 and symmetry axis 2 (the size of the mask is specified in voxels). Click on the created mask in the layer list and use the <strong>Export</strong> button to write it to disk.</p>
<figure class="align-default" id="id13">
<a class="reference internal image-reference" href="../../_images/masks.png"><img alt="../../_images/masks.png" src="../../_images/masks.png" style="width: 100%;" />
</a>
<figcaption>
<p><span class="caption-text">Using the napari GUI to create template matching masks.</span><a class="headerlink" href="#id13" title="Link to this image">#</a></p>
</figcaption>
</figure>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>In general, we find its beneficial to not make the mask too narrow. For HA for instance, a cylindrical mask of that diameter is not ideal (it should be larger), but sufficient for the data we are dealing with here. Furthermore, the mask should not include excessive amounts of membrane density, but rather focus on peripheral template components.</p>
</div>
<p>Alternatively, you can do this using Python</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">tme</span><span class="w"> </span><span class="kn">import</span> <span class="n">Density</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tme.matching_utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">create_mask</span>

<span class="n">mask</span> <span class="o">=</span> <span class="n">create_mask</span><span class="p">(</span>
    <span class="n">mask_type</span><span class="o">=</span><span class="s2">&quot;tube&quot;</span><span class="p">,</span>
    <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span><span class="mi">60</span><span class="p">,</span><span class="mi">60</span><span class="p">),</span>
    <span class="n">symmetry_axis</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">base_center</span><span class="o">=</span><span class="p">(</span><span class="mi">29</span><span class="p">,</span><span class="mi">29</span><span class="p">,</span><span class="mf">23.5</span><span class="p">),</span>
    <span class="n">inner_radius</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">outer_radius</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
    <span class="n">height</span><span class="o">=</span><span class="mi">37</span>
<span class="p">)</span>
<span class="n">Density</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">sampling_rate</span><span class="o">=</span><span class="mf">6.8</span><span class="p">)</span><span class="o">.</span><span class="n">to_file</span><span class="p">(</span><span class="s2">&quot;template_mask_6.8.mrc&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="template-matching">
<h2>Template Matching<a class="headerlink" href="#template-matching" title="Link to this heading">#</a></h2>
<p>The only difference to unconstrained template matching is that the seed points need to be passed to <code class="docutils literal notranslate"><span class="pre">match_template.py</span></code> via the <code class="docutils literal notranslate"><span class="pre">--orientations</span></code> argument.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>match_template.py<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-m<span class="w"> </span>tomogram_solvated_ctf_noise.mrc<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-i<span class="w"> </span>templates/ha_6.8_aligned.mrc<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--template-mask<span class="w"> </span>templates/template_mask_6.8.mrc<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-s<span class="w"> </span>FLC<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-a<span class="w"> </span><span class="m">7</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--backend<span class="w"> </span>cupy<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--memory-scaling<span class="w"> </span><span class="m">1</span>.0<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--orientations<span class="w"> </span>seed_points/SeedingPoints_40_80.star<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--orientations-scaling<span class="w"> </span><span class="m">1</span>.0<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--orientations-cone<span class="w"> </span><span class="m">20</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--orientations-uncertainty<span class="w"> </span><span class="m">6</span>,6,10<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--wedge-axes<span class="w"> </span><span class="m">2</span>,0<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--defocus<span class="w"> </span><span class="m">50000</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--pad-edges<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--invert-target-contrast<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--tilt-angles<span class="w"> </span>tilt_angles.txt<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-o<span class="w"> </span>ha_matching.pickle
</pre></div>
</div>
<p>For NA, simply replace the path in <code class="docutils literal notranslate"><span class="pre">-i</span></code> using the path to <cite>templates/na_6.8_aligned.mrc</cite> and change the path in <code class="docutils literal notranslate"><span class="pre">-o</span></code> to <cite>results/na_matching.pickle</cite>. We recommend running the above on a GPU using the cupy backend as shown.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">--orientations-cone</span> <span class="pre">20</span></code>: Limits template orientations to within a 20-degree cone around the normal vector of each seed point. This ensures that particles are only matched in biologically relevant orientations (e.g., membrane proteins oriented relative to the membrane surface).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--orientations-uncertainty</span> <span class="pre">6,6,10</span></code>: Defines an ellipsoidal search region around each seed point in voxels. The values represent the search radii in x, y, and z directions respectively. This accounts for uncertainty in the exact position of particles relative to seed points.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--orientations-scaling</span> <span class="pre">1.0</span></code>: Scaling factor for seed point coordinates. Use 1.0 when seed points and tomogram are at the same voxel size.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--wedge-axes</span> <span class="pre">2,0</span></code>: Specifies the projection axis (z=2) and tilt axis (x=0) used during tilt series acquisition.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--defocus</span> <span class="pre">50000</span></code>: Defocus value in Ångstrom for CTF correction (5 μm defocus).</p></li>
</ul>
<p>The output of constrained template matching is a pickle file containing the score space and identified orientations. We can explore the score space in the <code class="docutils literal notranslate"><span class="pre">preprocessor_gui.py</span></code> using the <strong>Import Pickle</strong> button. Shown below is a comparison of HA and NA matching using constrained and unconstrained matching, respectively. Note the increase in peak sharpness and decreased contribution of the membrane density in constrained matching. Achieving more uniform matching scores for HA would require a more stringently created mask. In essence, HAs orthogonal to the missing wedge score lower, because applying a wedge mask to the template density stretches the template, and pushes a considerable amount outside the mask. Alternatively, background correction could be performed, for instance using <code class="docutils literal notranslate"><span class="pre">--scramble-phases</span></code>.</p>
<figure class="align-default" id="id14">
<img alt="../../_images/scores.png" src="../../_images/scores.png" />
<figcaption>
<p><span class="caption-text">Comparison of scores acquired from constrained and unconstrained matching of HA and NA.</span><a class="headerlink" href="#id14" title="Link to this image">#</a></p>
</figcaption>
</figure>
</section>
<section id="analysis">
<h2>Analysis<a class="headerlink" href="#analysis" title="Link to this heading">#</a></h2>
<p>The output of constrained template matching can be used in the default postprocessing schemes, e.g., for particle picking. See the <a class="reference internal" href="../postprocessing/summary.html"><span class="doc">postprocessing section</span></a> for more details.</p>
</section>
<section id="references">
<h2>References<a class="headerlink" href="#references" title="Link to this heading">#</a></h2>
<aside class="footnote-list brackets">
<aside class="footnote brackets" id="id5" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id1">1</a><span class="fn-bracket">]</span></span>
<p>Maurer, V. J., Grunwald, L., Kennes, D. M., Kosinski, J. Constrained template matching using rejection sampling. bioRxiv 2025</p>
</aside>
<aside class="footnote brackets" id="id6" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id2">2</a><span class="fn-bracket">]</span></span>
<p>Rodriguez de Francisco, B., Bezault A., Xu, X. P., Hanein, D., Volkmann, N. MEPSi: A tool for simulating tomograms of membrane-embedded proteins JSB 214, 107921 (2022).</p>
</aside>
<aside class="footnote brackets" id="id7" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id3">3</a><span class="fn-bracket">]</span></span>
<p>Maurer, V. J., Siggel, M., Jensen, R. K., Mahamid, J., Kosinski, J., Pezeshkian, W. Helfrich Monte Carlo Flexible Fitting: physics-based, data-driven cell-scale simulations. bioRxiv 2025</p>
</aside>
<aside class="footnote brackets" id="id8" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id4">4</a><span class="fn-bracket">]</span></span>
<p>Lamm, L., Sieber, J., Chung, J.E. et al. (2024). MemBrain-seg: Deep learning-based segmentation of cellular membranes in cryo-electron tomography. bioRxiv, doi.org/10.1101/2024.01.05.574336</p>
</aside>
</aside>
</section>
</section>


                </article>
              
              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="particle_picking.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Picking Ribosomes</p>
      </div>
    </a>
    <a class="right-next"
       href="fitting.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Fitting Atomic Structures</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <dialog id="pst-secondary-sidebar-modal"></dialog>
                <div id="pst-secondary-sidebar" class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
<div
    id="pst-page-navigation-heading-2"
    class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> On this page
  </div>
  <nav class="bd-toc-nav page-toc" aria-labelledby="pst-page-navigation-heading-2">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#prerequisites">Prerequisites</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#data-structure">Data Structure</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#generating-seed-points">Generating Seed Points</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#creating-templates">Creating Templates</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#creating-template-masks">Creating Template Masks</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#template-matching">Template Matching</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#analysis">Analysis</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#references">References</a></li>
</ul>
  </nav></div>

  <div class="sidebar-secondary-item">
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../../_sources/quickstart/matching/constrained.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf"></script>
<script defer src="../../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">

  <p class="copyright">
    
      © Copyright 2023-2025, European Molecular Biology Laboratory.
      <br/>
    
  </p>
</div>
      
        <div class="footer-item">

  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 8.2.3.
    <br/>
  </p>
</div>
      
    </div>
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">
<p class="theme-version">
  <!-- # L10n: Setting the PST URL as an argument as this does not need to be localized -->
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.16.1.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>